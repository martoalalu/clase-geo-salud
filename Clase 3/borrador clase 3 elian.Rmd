---
title: "Borrador clase 3"
author: "Elian"
date: "16/7/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r}
library (sf)
library (tidyverse)
library (tmaptools)
library (RUMBA)
```


Descargando archivos de portales web

Hasta el momento trabajamos solo con archivos geojson o csv ubicados en repositorios que teníamos preparados para el curso y que estaban cuidadosamente seleccionados... pero ya estuvimos charlando que muchas veces los datos vienen un poco más desordenados o en formatos distintos a los que estuvimos trabajando. Entonces surge la pregunta: *¿cómo es el ejercicio de "conseguir" nuestros propios datos en la vida real?*

Hoy en día tenemos muchos portales de datos abiertos que nos permiten obtener información georeferenciada en múltiples formatos de archivos. Algunos de los portales que hemos mencionado anteriormente y de los que sacamos algunos de los datos con los que hemos trabajado son:

* [**Instituto Geográfico Nacional**](https://www.ign.gob.ar/NuestrasActividades/InformacionGeoespacial/CapasSIG)
* [**BA Data**](http://data.buenosaires.gob.ar/)
* [**Datos Argentina**](http://datos.gob.ar/)

Si hacemos un poquito de memoria, en la primer clase mencionamos que existen múltiples formatos de archivo que almacenan información geográfica. Por ejemplo:

* *SHP*
* *geojson*
* *KML*
* *CSV*

*SHP*

El formato ESRI Shapefile (SHP) es un formato de archivo propietario de datos espaciales desarrollado por la compañía ESRI, quien crea y comercializa software para Sistemas de Información Geográfica como Arc/Info o ArcGIS. Actualmente es un formato bastante estandarizado para el intercambio de información geográfica, por lo tanto puede ser bastante común que se encuentren con este tipo de archivos.

Habitualmente van a encontrar este tipo de archivos comprimidos en un .zip, donde pueden tener al menos 3 componentes: 

* *shp* - es el archivo que almacena las entidades geométricas de los objetos.
* *shx* - es el archivo que almacena el índice de las entidades geométricas.
* *dbf* - es la base de datos, en formato dBASE, donde se almacena la información de los atributos de los objetos.

Vamos a realizar un pequeño ejemplo práctico donde obtendremos los datos nosotros mismos, en formato SHP. 

Para comenzar, nos dirigimos a la página de [**BA Data**](http://data.buenosaires.gob.ar/), donde tenemos una gran cantidad de sets de datos abiertos y muchos de ellos son geográficos. Vamos a descargar trabajar con datos de movilidad de CABA. Les dejamos los links a continuación:

* [**Base de datos de estaciones**](https://cdn.buenosaires.gob.ar/datosabiertos/datasets/subte-estaciones/estaciones-de-subte-zip.zip)
* [**Base de datos de lineas**]https://cdn.buenosaires.gob.ar/datosabiertos/datasets/subte-estaciones/lineas-de-subte-zip.zip

*¿Pero entonces, cómo abrimos estos archivos?*

Primero tenemos que descomprimir los archivos en un directorio de nuestra PC. Luego podemos utilizar el tradicional read_sf que venimos utilizando para abrir nuestros archivos geográficos sobre el archivo con extensión SHP. 

```{r}
estaciones <- read_sf ("C:/Users/Elian/OneDrive/Escritorio/Ciencia de datos/Geo en Salud/estaciones-de-subte-zip/estaciones-de-subte.shp") #deben colocar el directorio donde descomprimieron el archivo

#vamos a explorar el archivo
head(estaciones)
summary(estaciones)

#qué tipo de objeto es?
class(estaciones)
```

Esto tiene buena pinta! Tenemos un objeto con formato SF sobre el cuál ya sabemos trabajar! Vamos a graficarlo.

```{r}
ggplot (estaciones) +
    geom_sf()
```

El objeto *estaciones* contiene las ubicaciones de las estaciones de subte de CABA.

Veamos que sucede con el segundo objeto que descargamos. Ya sabemos como leerlo:


```{r}
lineas <- read_sf("C:/Users/Elian/OneDrive/Escritorio/Ciencia de datos/Geo en Salud/lineas-de-subte-zip/lineas-subte.shp")

#vamos a explorar el archivo
head(lineas)
summary(lineas)

#qué tipo de objeto es?
class(lineas)

```

Vamos a hacer un mapa!

```{r}
ggplot (lineas) +
  geom_sf()
```

El gráfico nos muestra un objeto geométrico diferente! Ahora tenemos lineas que representan los recorridos de las líneas de subte. Y si combinamos los datos?

```{r}
ggplot() +
    geom_sf(data = lineas, color = "red") +
    geom_sf(data = estaciones, color = "orange") +
    labs(title = "Subte",
         subtitle = "CABA")
```

Okay, y si a esto lo ubicamos en contexto?

```{r}
#vamos a buscar uno de los mapas de CABA que trabajamos en clases anteriores. Noten que está en formato geojson.
caba <- read_sf("https://raw.githubusercontent.com/martoalalu/clase-geo-salud/clase-2021/data/caba.geojson")

ggplot() +
    geom_sf(data = caba) +
    geom_sf(data = lineas, color = "red") +
    geom_sf(data = estaciones, color = "orange") +
    labs(title = "Subte",
         subtitle = "CABA")


```

Si prestan atención, el mapa de caba fue obtenido de un archivo geojson y pudimos cargarlo sin problemas. Es decir que una vez que creamos un objeto SF, podemos manipularlo de la misma forma que estuvimos trabajando, sin importar el formato de origen.


Ahora veamos como cargar un archivo json de IGN

El IGN pone a disposición una serie de capas de información geoespacial en formato vectorial para su descarga. Esta información es consistente con el Catálogo de Objetos Geográficos del Organismo y forma parte de la Base de Datos Geoespacial Institucional. Todos los datos se encuentran expresados en coordenadas geodésicas, utilizando el Sistema de Referencia WGS 84 (Código EPSG:4326). 

El link del archivo con el que trabajaremos se adjunta a continuación: 

* [**Base de departamentos**](https://dnsg.ign.gob.ar/apps/api/v1/capas-sig/Geodesia+y+demarcaci%C3%B3n/L%C3%ADmites/departamento/json)

Una vez descargado el archivo, descomprimimos el ZIP. Adivinen qué podemos utilizar para abrir el archivo? read_sf!

```{r}
departamentos <- read_sf ("C:/Users/Elian/OneDrive/Escritorio/Ciencia de datos/Geo en Salud/departamento/departamento.json")

summary (departamentos)


ggplot (departamentos) +
  geom_sf()
```


--------------------------------------------------------------------------------------------------------

Geocodificando

OpenStreetMap (también conocido como OSM) es un proyecto colaborativo para crear mapas editables y libres. En lugar del mapa en sí, los datos generados por el proyecto se consideran su salida principal. Los mapas se crean utilizando información geográfica capturada con dispositivos GPS móviles, ortofotografías y otras fuentes libres. Esta cartografía, tanto las imágenes creadas como los datos vectoriales almacenados en su base de datos, se distribuye bajo licencia abierta Licencia Abierta de Bases de Datos.

Los contribuidores más entusiastas mapean barrios completos utilizando herramientas GPS para enviar información local completa, actualizada y precisa a OpenStreetMap. Varias empresas y entidades públicas que producen información geográfica también contribuyen al permitir que sus datos sean incluidos. Existen equipos profesionales de contribuidores que que se coordinan para agregar y mantener actualizada información georeferenciada de límites políticos, calles, edificios, negocios y otros puntos de interés.

Toda la información disponible en OpenStreetMap puede ser descargada y reutilizada por cualquier persona, ya sea accediendo al mapa online, obteniendo una copia completa de la base de datos, o accediendo a los datos vía API.

Entonces... qué es geocodificar?

Es el proceso de asignar coordenadas (ergo, localización espacial) a uno o varios atributos alfanuméricos que constituyen una dirección. Se requiere de 4 argumentos fundamentales para ello: Calle, Altura o número, Localidad y Estado o Provincia. Otros atributos mejoran la calidad y la precisión: Barrio, País, Código Postal, Números de teléfono, etc.

Para geocodificar hacemos uso de APIs y servicios geográficos, en este caso, veremos cómo usar el de OSM (Nominatim)

Empecemos!

Vamos a obtener los datos de una base de datos de centros de salud municipales de Cordoba capital.

```{r}
Centros_Salud <- readxl::read_xlsx("C:/Users/Elian/OneDrive/Escritorio/Ciencia de datos/Geo en Salud/Clase 3/Listado_Centros_de_Salud_Municipales_2020_boo5c9g.xlsx")

head (Centros_Salud)

summary(Centros_Salud)

sum(is.na(Centros_Salud$Altura)) #Tenemos varios valores nulos
```


Para acceder a las funcionalidades de la API usaremos la libería tmaptools , que tiene una amplia funcionalidad, entre ellas, conectarse a los servicios de OSM.

```{r}
# Transformar la tabla y construir un solo campo de dirección
Centros_Salud_Direccion <- Centros_Salud %>% 
  mutate(Dir_completa = paste(Calle, Altura, ",", Localidad, ", Argentina"))


head(Centros_Salud_Direccion)
```


Vamos a geocodificar nuestras direcciones

```{r}
Centros_Salud_Direccion <- Centros_Salud_Direccion %>% 
  mutate(geo=geocode_OSM(  #me devuelve las coordenadas (geocode_OSM) en un campo adicional a los originales
    Centros_Salud_Direccion$Dir_completa,  
    return.first.only = TRUE,  # me devuelve solo el primer resultado encontrado, FALSE si quieres lo contrario
    keep.unfound = TRUE,  # que mantenga aquellas direcciones que No pudo geolocalizar, con un null en el campo "geo"
    details = FALSE, # que no devuelva detalles, id de OSM u objetos cercanos, TRUE si quieres lo contrario
    as.data.frame = NA,
    as.sf = FALSE, # que lo deje como una tabla y no lo convierta en un spatial frame
    geometry = "point", # que la geometría sea de tipo PUNTO (es decir, un par de coordenadas)
    server = "https://nominatim.openstreetmap.org" # el servicio que deseo usar: Nominatim
  ))


summary (Centros_Salud_Direccion$geo)

# Base final con coordenadas
Centros_Salud_Direccion <- Centros_Salud_Direccion %>% 
  mutate(lon=geo$lon, lat = geo$lat) %>% # el campo geo se arma como lista, deberás seleccionar una lon y una lat
  select(`Centro de Salud`, Dir_completa, lon, lat)

summary (Centros_Salud_Direccion)

nrow (Centros_Salud_Direccion)

#qué nos falta para que sea un objeto geográfico? Agregar el sistema de referencia!
Centros_Salud_Direccion <- Centros_Salud_Direccion %>% 
  filter(!is.na(lon), !is.na(lat)) %>% 
  st_as_sf(coords = c("lon", "lat"), crs = 4326)

summary (Centros_Salud_Direccion)

class(Centros_Salud_Direccion)

```


-------------------------------------------------------------------------------------------------------

Hay otros servicios para trabajar datos!

USIG es la Unidad de Sistemas de Información Geográfica del Gobierno de la Ciudad de Buenos Aires y brinda un servicio de geocodificación (entre otras cosas) de datos de la Ciudad de Buenos Aires de manera gratuita!!

La librería que nos facilita el uso de este servicio se llama RUMBA, la cual la instalamos con el clásico install.packages("RUMBA").

RUMBA es un conjunto de herramientas para el análisis de la Región Urbana Metropolitana de Buenos Aires usando R. Incluye cuatro funciones que permiten obtener coordenadas precisas (longitud y latitud) que corresponden a direcciones dentro de los límites de la Región Urbana Metropolitana de Buenos Aires o bien de barrios vulnerables de la Ciudad de Buenos Aires.

Las funciones consultan la API del Normalizador de direcciones y de Déficit Habitacional de la USIG. Ademas de las coordenadas, se obtiene la dirección normalizada (escrita de forma inequívoca).

Les proponemos analizar las posta de vacunación de CABA

```{r}
Postas_Vacunacion <-  readxl::read_xlsx("C:/Users/Elian/OneDrive/Escritorio/Ciencia de datos/Geo en Salud/Clase 3/postas_vacunacion_covid.xlsx")

head(Postas_Vacunacion)

```

El dataframe tiene una columna que tiene la dirección. Pero no tenemos ni latitud ni longitud. Ya sabemos que podemos geocodificar los datos! Vamos a probar el servicio de la USIG.

Con la función mutate_USIG_geocode podemos agregar las columnas de lon y lat y así tener las coordenadas. La dirección debe estar expresada como “calle altura, partido”, “calle altura, municipio”, “calle y calle, partido”, o “calle altura, municipio”. El partido o municipio son opcionales. De no ser aclarados, y encontrarse múltiples direcciones que coincidan con la búsqueda, se entregaran las coordenadas dentro de la Ciudad Autónoma de Buenos Aires (si existieran), o en su defecto las del primer partido -por orden alfabético- donde se haya encontrado la dirección.

En resumen: es mejor incluir partido o municipio en las direcciones a georeferenciar.

```{r}
Postas_Vacunacion_Direccion <- mutate_USIG_geocode(Postas_Vacunacion, "direccion") #paciencia. Puede tardar un poco!

head(Postas_Vacunacion_Direccion)

#Solo nos queda transformarlo a objeto geográfico
Postas_Vacunacion_Direccion <- Postas_Vacunacion_Direccion %>% 
  filter(!is.na(lon), !is.na(lat)) %>% 
  st_as_sf(coords = c("lon", "lat"), crs = 4326)

summary (Postas_Vacunacion_Direccion)

class(Postas_Vacunacion_Direccion)

```



